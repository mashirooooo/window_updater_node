"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto"),t=require("path"),n=require("fs"),s=require("zlib");
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function r(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{h(s.next(e))}catch(e){i(e)}}function o(e){try{h(s.throw(e))}catch(e){i(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}h((s=s.apply(e,t||[])).next())}))}var i="object"==typeof process&&process&&"win32"===process.platform?{sep:"\\"}:{sep:"/"},a=o;function o(e,t,n){e instanceof RegExp&&(e=h(e,n)),t instanceof RegExp&&(t=h(t,n));var s=c(e,t,n);return s&&{start:s[0],end:s[1],pre:n.slice(0,s[0]),body:n.slice(s[0]+e.length,s[1]),post:n.slice(s[1]+t.length)}}function h(e,t){var n=t.match(e);return n?n[0]:null}function c(e,t,n){var s,r,i,a,o,h=n.indexOf(e),c=n.indexOf(t,h+1),l=h;if(h>=0&&c>0){if(e===t)return[h,c];for(s=[],i=n.length;l>=0&&!o;)l==h?(s.push(l),h=n.indexOf(e,l+1)):1==s.length?o=[s.pop(),c]:((r=s.pop())<i&&(i=r,a=c),c=n.indexOf(t,l+1)),l=h<c&&h>=0?h:c;s.length&&(o=[i,a])}return o}o.range=c;var l=a,u=function(e){if(!e)return[];"{}"===e.substr(0,2)&&(e="\\{\\}"+e.substr(2));return S(function(e){return e.split("\\\\").join(p).split("\\{").join(d).split("\\}").join(f).split("\\,").join(g).split("\\.").join(m)}(e),!0).map(v)},p="\0SLASH"+Math.random()+"\0",d="\0OPEN"+Math.random()+"\0",f="\0CLOSE"+Math.random()+"\0",g="\0COMMA"+Math.random()+"\0",m="\0PERIOD"+Math.random()+"\0";function b(e){return parseInt(e,10)==e?parseInt(e,10):e.charCodeAt(0)}function v(e){return e.split(p).join("\\").split(d).join("{").split(f).join("}").split(g).join(",").split(m).join(".")}function x(e){if(!e)return[""];var t=[],n=l("{","}",e);if(!n)return e.split(",");var s=n.pre,r=n.body,i=n.post,a=s.split(",");a[a.length-1]+="{"+r+"}";var o=x(i);return i.length&&(a[a.length-1]+=o.shift(),a.push.apply(a,o)),t.push.apply(t,a),t}function y(e){return"{"+e+"}"}function j(e){return/^-?0\d/.test(e)}function w(e,t){return e<=t}function E(e,t){return e>=t}function S(e,t){var n=[],s=l("{","}",e);if(!s)return[e];var r=s.pre,i=s.post.length?S(s.post,!1):[""];if(/\$$/.test(s.pre))for(var a=0;a<i.length;a++){var o=r+"{"+s.body+"}"+i[a];n.push(o)}else{var h,c,u=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(s.body),p=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(s.body),d=u||p,g=s.body.indexOf(",")>=0;if(!d&&!g)return s.post.match(/,.*\}/)?S(e=s.pre+"{"+s.body+f+s.post):[e];if(d)h=s.body.split(/\.\./);else if(1===(h=x(s.body)).length&&1===(h=S(h[0],!1).map(y)).length)return i.map((function(e){return s.pre+h[0]+e}));if(d){var m=b(h[0]),v=b(h[1]),O=Math.max(h[0].length,h[1].length),R=3==h.length?Math.abs(b(h[2])):1,k=w;v<m&&(R*=-1,k=E);var A=h.some(j);c=[];for(var H=m;k(H,v);H+=R){var M;if(p)"\\"===(M=String.fromCharCode(H))&&(M="");else if(M=String(H),A){var $=O-M.length;if($>0){var C=new Array($+1).join("0");M=H<0?"-"+C+M.slice(1):C+M}}c.push(M)}}else{c=[];for(var F=0;F<h.length;F++)c.push.apply(c,S(h[F],!1))}for(F=0;F<c.length;F++)for(a=0;a<i.length;a++){o=r+c[F]+i[a];(!t||d||o)&&n.push(o)}}return n}const O=R=(e,t,n={})=>(T(t),!(!n.nocomment&&"#"===t.charAt(0))&&new U(t,n).match(e));var R=O;const k=i;O.sep=k.sep;const A=Symbol("globstar **");O.GLOBSTAR=A;const H=u,M={"!":{open:"(?:(?!(?:",close:"))[^/]*?)"},"?":{open:"(?:",close:")?"},"+":{open:"(?:",close:")+"},"*":{open:"(?:",close:")*"},"@":{open:"(?:",close:")"}},$=e=>e.split("").reduce(((e,t)=>(e[t]=!0,e)),{}),C=$("().*{}+?[]^$\\!"),F=$("[.("),P=/\/+/;O.filter=(e,t={})=>(n,s,r)=>O(n,e,t);const q=(e,t={})=>{const n={};return Object.keys(e).forEach((t=>n[t]=e[t])),Object.keys(t).forEach((e=>n[e]=t[e])),n};O.defaults=e=>{if(!e||"object"!=typeof e||!Object.keys(e).length)return O;const t=O,n=(n,s,r)=>t(n,s,q(e,r));return(n.Minimatch=class extends t.Minimatch{constructor(t,n){super(t,q(e,n))}}).defaults=n=>t.defaults(q(e,n)).Minimatch,n.filter=(n,s)=>t.filter(n,q(e,s)),n.defaults=n=>t.defaults(q(e,n)),n.makeRe=(n,s)=>t.makeRe(n,q(e,s)),n.braceExpand=(n,s)=>t.braceExpand(n,q(e,s)),n.match=(n,s,r)=>t.match(n,s,q(e,r)),n},O.braceExpand=(e,t)=>z(e,t);const z=(e,t={})=>(T(e),t.nobrace||!/\{(?:(?!\{).)*\}/.test(e)?[e]:H(e)),T=e=>{if("string"!=typeof e)throw new TypeError("invalid pattern");if(e.length>65536)throw new TypeError("pattern is too long")},N=Symbol("subparse");O.makeRe=(e,t)=>new U(e,t||{}).makeRe(),O.match=(e,t,n={})=>{const s=new U(t,n);return e=e.filter((e=>s.match(e))),s.options.nonull&&!e.length&&e.push(t),e};class U{constructor(e,t){T(e),t||(t={}),this.options=t,this.set=[],this.pattern=e,this.regexp=null,this.negate=!1,this.comment=!1,this.empty=!1,this.partial=!!t.partial,this.make()}debug(){}make(){const e=this.pattern,t=this.options;if(!t.nocomment&&"#"===e.charAt(0))return void(this.comment=!0);if(!e)return void(this.empty=!0);this.parseNegate();let n=this.globSet=this.braceExpand();t.debug&&(this.debug=(...e)=>console.error(...e)),this.debug(this.pattern,n),n=this.globParts=n.map((e=>e.split(P))),this.debug(this.pattern,n),n=n.map(((e,t,n)=>e.map(this.parse,this))),this.debug(this.pattern,n),n=n.filter((e=>-1===e.indexOf(!1))),this.debug(this.pattern,n),this.set=n}parseNegate(){if(this.options.nonegate)return;const e=this.pattern;let t=!1,n=0;for(let s=0;s<e.length&&"!"===e.charAt(s);s++)t=!t,n++;n&&(this.pattern=e.substr(n)),this.negate=t}matchOne(e,t,n){var s=this.options;this.debug("matchOne",{this:this,file:e,pattern:t}),this.debug("matchOne",e.length,t.length);for(var r=0,i=0,a=e.length,o=t.length;r<a&&i<o;r++,i++){this.debug("matchOne loop");var h,c=t[i],l=e[r];if(this.debug(t,c,l),!1===c)return!1;if(c===A){this.debug("GLOBSTAR",[t,c,l]);var u=r,p=i+1;if(p===o){for(this.debug("** at the end");r<a;r++)if("."===e[r]||".."===e[r]||!s.dot&&"."===e[r].charAt(0))return!1;return!0}for(;u<a;){var d=e[u];if(this.debug("\nglobstar while",e,u,t,p,d),this.matchOne(e.slice(u),t.slice(p),n))return this.debug("globstar found match!",u,a,d),!0;if("."===d||".."===d||!s.dot&&"."===d.charAt(0)){this.debug("dot detected!",e,u,t,p);break}this.debug("globstar swallow a segment, and continue"),u++}return!(!n||(this.debug("\n>>> no match, partial?",e,u,t,p),u!==a))}if("string"==typeof c?(h=l===c,this.debug("string match",c,l,h)):(h=l.match(c),this.debug("pattern match",c,l,h)),!h)return!1}if(r===a&&i===o)return!0;if(r===a)return n;if(i===o)return r===a-1&&""===e[r];throw new Error("wtf?")}braceExpand(){return z(this.pattern,this.options)}parse(e,t){T(e);const n=this.options;if("**"===e){if(!n.noglobstar)return A;e="*"}if(""===e)return"";let s="",r=!!n.nocase,i=!1;const a=[],o=[];let h,c,l,u,p=!1,d=-1,f=-1;const g="."===e.charAt(0)?"":n.dot?"(?!(?:^|\\/)\\.{1,2}(?:$|\\/))":"(?!\\.)",m=()=>{if(h){switch(h){case"*":s+="[^/]*?",r=!0;break;case"?":s+="[^/]",r=!0;break;default:s+="\\"+h}this.debug("clearStateChar %j %j",h,s),h=!1}};for(let t,g=0;g<e.length&&(t=e.charAt(g));g++)if(this.debug("%s\t%s %s %j",e,g,s,t),i){if("/"===t)return!1;C[t]&&(s+="\\"),s+=t,i=!1}else switch(t){case"/":return!1;case"\\":m(),i=!0;continue;case"?":case"*":case"+":case"@":case"!":if(this.debug("%s\t%s %s %j <-- stateChar",e,g,s,t),p){this.debug("  in class"),"!"===t&&g===f+1&&(t="^"),s+=t;continue}this.debug("call clearStateChar %j",h),m(),h=t,n.noext&&m();continue;case"(":if(p){s+="(";continue}if(!h){s+="\\(";continue}a.push({type:h,start:g-1,reStart:s.length,open:M[h].open,close:M[h].close}),s+="!"===h?"(?:(?!(?:":"(?:",this.debug("plType %j %j",h,s),h=!1;continue;case")":if(p||!a.length){s+="\\)";continue}m(),r=!0,l=a.pop(),s+=l.close,"!"===l.type&&o.push(l),l.reEnd=s.length;continue;case"|":if(p||!a.length){s+="\\|";continue}m(),s+="|";continue;case"[":if(m(),p){s+="\\"+t;continue}p=!0,f=g,d=s.length,s+=t;continue;case"]":if(g===f+1||!p){s+="\\"+t;continue}c=e.substring(f+1,g);try{RegExp("["+c+"]")}catch(e){u=this.parse(c,N),s=s.substr(0,d)+"\\["+u[0]+"\\]",r=r||u[1],p=!1;continue}r=!0,p=!1,s+=t;continue;default:m(),!C[t]||"^"===t&&p||(s+="\\"),s+=t}for(p&&(c=e.substr(f+1),u=this.parse(c,N),s=s.substr(0,d)+"\\["+u[0],r=r||u[1]),l=a.pop();l;l=a.pop()){let e;e=s.slice(l.reStart+l.open.length),this.debug("setting tail",s,l),e=e.replace(/((?:\\{2}){0,64})(\\?)\|/g,((e,t,n)=>(n||(n="\\"),t+t+n+"|"))),this.debug("tail=%j\n   %s",e,e,l,s);const t="*"===l.type?"[^/]*?":"?"===l.type?"[^/]":"\\"+l.type;r=!0,s=s.slice(0,l.reStart)+t+"\\("+e}m(),i&&(s+="\\\\");const b=F[s.charAt(0)];for(let e=o.length-1;e>-1;e--){const n=o[e],r=s.slice(0,n.reStart),i=s.slice(n.reStart,n.reEnd-8);let a=s.slice(n.reEnd);const h=s.slice(n.reEnd-8,n.reEnd)+a,c=r.split("(").length-1;let l=a;for(let e=0;e<c;e++)l=l.replace(/\)[+*?]?/,"");a=l;s=r+i+a+(""===a&&t!==N?"$":"")+h}if(""!==s&&r&&(s="(?=.)"+s),b&&(s=g+s),t===N)return[s,r];if(!r)return e.replace(/\\(.)/g,"$1");const v=n.nocase?"i":"";try{return Object.assign(new RegExp("^"+s+"$",v),{_glob:e,_src:s})}catch(e){return new RegExp("$.")}}makeRe(){if(this.regexp||!1===this.regexp)return this.regexp;const e=this.set;if(!e.length)return this.regexp=!1,this.regexp;const t=this.options,n=t.noglobstar?"[^/]*?":t.dot?"(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?":"(?:(?!(?:\\/|^)\\.).)*?",s=t.nocase?"i":"";let r=e.map((e=>(e=e.map((e=>"string"==typeof e?e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"):e===A?A:e._src)).reduce(((e,t)=>(e[e.length-1]===A&&t===A||e.push(t),e)),[]),e.forEach(((t,s)=>{t===A&&e[s-1]!==A&&(0===s?e.length>1?e[s+1]="(?:\\/|"+n+"\\/)?"+e[s+1]:e[s]=n:s===e.length-1?e[s-1]+="(?:\\/|"+n+")?":(e[s-1]+="(?:\\/|\\/"+n+"\\/)"+e[s+1],e[s+1]=A))})),e.filter((e=>e!==A)).join("/")))).join("|");r="^(?:"+r+")$",this.negate&&(r="^(?!"+r+").*$");try{this.regexp=new RegExp(r,s)}catch(e){this.regexp=!1}return this.regexp}match(e,t=this.partial){if(this.debug("match",e,this.pattern),this.comment)return!1;if(this.empty)return""===e;if("/"===e&&t)return!0;const n=this.options;"/"!==k.sep&&(e=e.split(k.sep).join("/")),e=e.split(P),this.debug(this.pattern,"split",e);const s=this.set;let r;this.debug(this.pattern,"set",s);for(let t=e.length-1;t>=0&&(r=e[t],!r);t--);for(let i=0;i<s.length;i++){const a=s[i];let o=e;n.matchBase&&1===a.length&&(o=[r]);if(this.matchOne(o,a,t))return!!n.flipNegate||!this.negate}return!n.flipNegate&&this.negate}static defaults(e){return O.defaults(e).Minimatch}}O.Minimatch=U;class D{}class G extends D{}class I{constructor(){this.added=[],this.changed=[]}}var _;exports.UpdateStatus=void 0,(_=exports.UpdateStatus||(exports.UpdateStatus={}))[_.HaveNothingUpdate=0]="HaveNothingUpdate",_[_.Success=1]="Success",_[_.Failed=2]="Failed";class L{constructor(e,t){this.queue=[],this.activeCount=0,this.concurrency=e,this.onFinnish=t}addTask(e){return r(this,void 0,void 0,(function*(){this.queue.push(e),this.run()}))}stop(){this.queue=[]}run(){return r(this,void 0,void 0,(function*(){if(0===this.activeCount&&0===this.queue.length&&this.onFinnish&&this.onFinnish(),this.activeCount<this.concurrency&&this.queue.length>0){const e=this.queue.shift();this.activeCount++,e.task().then((t=>{e.taskReslove&&e.taskReslove(t)})).catch((t=>{e.taskReject&&e.taskReject(t)})).finally((()=>{this.activeCount--,this.run()}))}}))}}function V(t){return e.createHash("sha256").update(t).digest("hex")}function B(e,t){if("function"==typeof e)return e(t);if(e&&Array.isArray(e)&&0!==e.length){return new RegExp(e.reduce(((e,t)=>e+"|"+R.makeRe(t).source),"").substring(1)).test(t)}return!1}function W(e,s={}){var r,i;const a=n.statSync(e),o=t.basename(e);if(a.isFile()){if(B(null===(r=null==s?void 0:s.files)||void 0===r?void 0:r.exclude,o))return null;const t=new D;return t.name=o,t.hash=V(n.readFileSync(e)),t}if(a.isDirectory()){if(B(null===(i=null==s?void 0:s.folders)||void 0===i?void 0:i.exclude,o))return null;const r=new G;return r.name=o,r.children=n.readdirSync(e).map((n=>W(t.join(e,n),s))).filter((e=>null!==e)),r.hash=V(r.children.map((e=>e.hash)).join("")),r}return null}function Z(e,t,n){e.children?e.children.forEach((e=>{Z(e,t+"/"+e.name,n)})):n.push({filePath:t,hash:e.hash})}function Q(e,t){return new Promise(((r,i)=>{const a=s.createGzip(),o=n.createWriteStream(t),h=n.createReadStream(e);h.on("close",r),h.on("error",i),o.on("error",i),h.pipe(a).pipe(o)}))}exports.DiffVersionHashResult=I,exports.DiffVersionHashResultItem=class{},exports.HashedFile=D,exports.HashedFolder=G,exports.UpdateInfo=class{constructor(){this.status="init",this.message=""}},exports.checkFileExitAndHash=function(e,t){return new Promise((s=>{n.stat(e,((n,r)=>{var i;s(!n&&(r.isFile()&&(null===(i=W(e))||void 0===i?void 0:i.hash)===t))}))}))},exports.diffVersionHash=function e(t,n,s=new I,r="."){return n.hash===t.hash||(n.children?n.children.forEach((n=>{n=n,t.childrenObject&&t.childrenObject[n.name]?e(t.childrenObject[n.name],n,s,r+"/"+n.name):Z(n,r+"/"+n.name,s.added)})):s.changed.push({filePath:r,hash:n.hash})),s},exports.downAndungzip=function(t,r,i,a){return new Promise(((o,h)=>{if(n.existsSync(i)&&V(n.readFileSync(i))===t)o(!0);else{const c=e.createHash("sha256"),l=s.createGunzip(),u=n.createWriteStream(i);a(r).then((e=>{e.pipe(l),e.once("error",(e=>{l.close(),u.close(),c.destroy(),h(e)})),l.pipe(c),l.pipe(u),e.once("end",(()=>{c.digest("hex")!==t?(c.destroy(),h(new Error("下载文件出错"))):o(!0)}))}),(e=>{h(e)}))}}))},exports.gzip=Q,exports.handleHashedFolderChildrenToObject=function e(t){t&&t.children&&(t.childrenObject=t.children.reduce(((t,n)=>(n.children&&e(n),t[n.name]=n,t)),{}))},exports.hash256=V,exports.hashElement=W,exports.hashElementPromiseQueue=function s(r,i={},a=1){return new Promise(((o,h)=>{n.stat(r,((c,l)=>{var u,p;if(c)h(c);else{const c=t.basename(r);if(l.isFile()){if(B(null===(u=null==i?void 0:i.files)||void 0===u?void 0:u.exclude,c))return o(null);const t=new D;t.name=c;const s=n.createReadStream(r),a=e.createHash("sha256");s.pipe(a),s.on("end",(()=>{t.hash=a.digest("hex"),o(t),s.close()})),s.on("error",(e=>{h(e)}))}else{if(!l.isDirectory())return o(null);{if(B(null===(p=null==i?void 0:i.folders)||void 0===p?void 0:p.exclude,c))return o(null);const e=new G;e.name=c;const l=n.readdirSync(r),u=[],d=new L(a,(()=>{e.children=u.filter((e=>null!==e)),e.hash=V(e.children.map((e=>e.hash)).join("")),o(e)}));for(const e of l)d.addTask({task:()=>s(t.join(r,e),i),taskReslove:e=>{u.push(e)},taskReject:e=>{d.stop(),h(e)}})}}}}))}))},exports.pushdiffVersionHashResult=Z,exports.reduceGlobPatterns=B,exports.zipHashElement=function e(n,s,i,a=!1){return r(this,void 0,void 0,(function*(){if(n.children)for(let t=0;t<n.children.length;t++)yield e(n.children[t],s+(a?"":"/"+n.name),i);else yield Q(s+"/"+n.name,t.join(i,n.hash+".gz"))}))};
