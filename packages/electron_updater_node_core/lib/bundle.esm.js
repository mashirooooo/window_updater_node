import{createHash as t}from"crypto";import{basename as e,join as n}from"path";import{statSync as r,readFileSync as s,readdirSync as i,stat as o,createReadStream as a,createWriteStream as h,existsSync as c}from"fs";import{createGzip as l,createGunzip as u}from"zlib";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function p(t,e,n,r){return new(n||(n=Promise))((function(s,i){function o(t){try{h(r.next(t))}catch(t){i(t)}}function a(t){try{h(r.throw(t))}catch(t){i(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}h((r=r.apply(t,e||[])).next())}))}var f="object"==typeof process&&process&&"win32"===process.platform?{sep:"\\"}:{sep:"/"},d=g;function g(t,e,n){t instanceof RegExp&&(t=m(t,n)),e instanceof RegExp&&(e=m(e,n));var r=b(t,e,n);return r&&{start:r[0],end:r[1],pre:n.slice(0,r[0]),body:n.slice(r[0]+t.length,r[1]),post:n.slice(r[1]+e.length)}}function m(t,e){var n=e.match(t);return n?n[0]:null}function b(t,e,n){var r,s,i,o,a,h=n.indexOf(t),c=n.indexOf(e,h+1),l=h;if(h>=0&&c>0){if(t===e)return[h,c];for(r=[],i=n.length;l>=0&&!a;)l==h?(r.push(l),h=n.indexOf(t,l+1)):1==r.length?a=[r.pop(),c]:((s=r.pop())<i&&(i=s,o=c),c=n.indexOf(e,l+1)),l=h<c&&h>=0?h:c;r.length&&(a=[i,o])}return a}g.range=b;var v=d,y=function(t){if(!t)return[];"{}"===t.substr(0,2)&&(t="\\{\\}"+t.substr(2));return P(function(t){return t.split("\\\\").join(x).split("\\{").join(j).split("\\}").join(w).split("\\,").join(E).split("\\.").join(O)}(t),!0).map(R)},x="\0SLASH"+Math.random()+"\0",j="\0OPEN"+Math.random()+"\0",w="\0CLOSE"+Math.random()+"\0",E="\0COMMA"+Math.random()+"\0",O="\0PERIOD"+Math.random()+"\0";function k(t){return parseInt(t,10)==t?parseInt(t,10):t.charCodeAt(0)}function R(t){return t.split(x).join("\\").split(j).join("{").split(w).join("}").split(E).join(",").split(O).join(".")}function S(t){if(!t)return[""];var e=[],n=v("{","}",t);if(!n)return t.split(",");var r=n.pre,s=n.body,i=n.post,o=r.split(",");o[o.length-1]+="{"+s+"}";var a=S(i);return i.length&&(o[o.length-1]+=a.shift(),o.push.apply(o,a)),e.push.apply(e,o),e}function A(t){return"{"+t+"}"}function $(t){return/^-?0\d/.test(t)}function M(t,e){return t<=e}function C(t,e){return t>=e}function P(t,e){var n=[],r=v("{","}",t);if(!r)return[t];var s=r.pre,i=r.post.length?P(r.post,!1):[""];if(/\$$/.test(r.pre))for(var o=0;o<i.length;o++){var a=s+"{"+r.body+"}"+i[o];n.push(a)}else{var h,c,l=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(r.body),u=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(r.body),p=l||u,f=r.body.indexOf(",")>=0;if(!p&&!f)return r.post.match(/,.*\}/)?P(t=r.pre+"{"+r.body+w+r.post):[t];if(p)h=r.body.split(/\.\./);else if(1===(h=S(r.body)).length&&1===(h=P(h[0],!1).map(A)).length)return i.map((function(t){return r.pre+h[0]+t}));if(p){var d=k(h[0]),g=k(h[1]),m=Math.max(h[0].length,h[1].length),b=3==h.length?Math.abs(k(h[2])):1,y=M;g<d&&(b*=-1,y=C);var x=h.some($);c=[];for(var j=d;y(j,g);j+=b){var E;if(u)"\\"===(E=String.fromCharCode(j))&&(E="");else if(E=String(j),x){var O=m-E.length;if(O>0){var R=new Array(O+1).join("0");E=j<0?"-"+R+E.slice(1):R+E}}c.push(E)}}else{c=[];for(var F=0;F<h.length;F++)c.push.apply(c,P(h[F],!1))}for(F=0;F<c.length;F++)for(o=0;o<i.length;o++){a=s+c[F]+i[o];(!e||p||a)&&n.push(a)}}return n}const F=N=(t,e,n={})=>(U(e),!(!n.nocomment&&"#"===e.charAt(0))&&new J(e,n).match(t));var N=F;const T=f;F.sep=T.sep;const q=Symbol("globstar **");F.GLOBSTAR=q;const z=y,L={"!":{open:"(?:(?!(?:",close:"))[^/]*?)"},"?":{open:"(?:",close:")?"},"+":{open:"(?:",close:")+"},"*":{open:"(?:",close:")*"},"@":{open:"(?:",close:")"}},B=t=>t.split("").reduce(((t,e)=>(t[e]=!0,t)),{}),D=B("().*{}+?[]^$\\!"),H=B("[.("),I=/\/+/;F.filter=(t,e={})=>(n,r,s)=>F(n,t,e);const _=(t,e={})=>{const n={};return Object.keys(t).forEach((e=>n[e]=t[e])),Object.keys(e).forEach((t=>n[t]=e[t])),n};F.defaults=t=>{if(!t||"object"!=typeof t||!Object.keys(t).length)return F;const e=F,n=(n,r,s)=>e(n,r,_(t,s));return(n.Minimatch=class extends e.Minimatch{constructor(e,n){super(e,_(t,n))}}).defaults=n=>e.defaults(_(t,n)).Minimatch,n.filter=(n,r)=>e.filter(n,_(t,r)),n.defaults=n=>e.defaults(_(t,n)),n.makeRe=(n,r)=>e.makeRe(n,_(t,r)),n.braceExpand=(n,r)=>e.braceExpand(n,_(t,r)),n.match=(n,r,s)=>e.match(n,r,_(t,s)),n},F.braceExpand=(t,e)=>G(t,e);const G=(t,e={})=>(U(t),e.nobrace||!/\{(?:(?!\{).)*\}/.test(t)?[t]:z(t)),U=t=>{if("string"!=typeof t)throw new TypeError("invalid pattern");if(t.length>65536)throw new TypeError("pattern is too long")},Z=Symbol("subparse");F.makeRe=(t,e)=>new J(t,e||{}).makeRe(),F.match=(t,e,n={})=>{const r=new J(e,n);return t=t.filter((t=>r.match(t))),r.options.nonull&&!t.length&&t.push(e),t};class J{constructor(t,e){U(t),e||(e={}),this.options=e,this.set=[],this.pattern=t,this.regexp=null,this.negate=!1,this.comment=!1,this.empty=!1,this.partial=!!e.partial,this.make()}debug(){}make(){const t=this.pattern,e=this.options;if(!e.nocomment&&"#"===t.charAt(0))return void(this.comment=!0);if(!t)return void(this.empty=!0);this.parseNegate();let n=this.globSet=this.braceExpand();e.debug&&(this.debug=(...t)=>console.error(...t)),this.debug(this.pattern,n),n=this.globParts=n.map((t=>t.split(I))),this.debug(this.pattern,n),n=n.map(((t,e,n)=>t.map(this.parse,this))),this.debug(this.pattern,n),n=n.filter((t=>-1===t.indexOf(!1))),this.debug(this.pattern,n),this.set=n}parseNegate(){if(this.options.nonegate)return;const t=this.pattern;let e=!1,n=0;for(let r=0;r<t.length&&"!"===t.charAt(r);r++)e=!e,n++;n&&(this.pattern=t.substr(n)),this.negate=e}matchOne(t,e,n){var r=this.options;this.debug("matchOne",{this:this,file:t,pattern:e}),this.debug("matchOne",t.length,e.length);for(var s=0,i=0,o=t.length,a=e.length;s<o&&i<a;s++,i++){this.debug("matchOne loop");var h,c=e[i],l=t[s];if(this.debug(e,c,l),!1===c)return!1;if(c===q){this.debug("GLOBSTAR",[e,c,l]);var u=s,p=i+1;if(p===a){for(this.debug("** at the end");s<o;s++)if("."===t[s]||".."===t[s]||!r.dot&&"."===t[s].charAt(0))return!1;return!0}for(;u<o;){var f=t[u];if(this.debug("\nglobstar while",t,u,e,p,f),this.matchOne(t.slice(u),e.slice(p),n))return this.debug("globstar found match!",u,o,f),!0;if("."===f||".."===f||!r.dot&&"."===f.charAt(0)){this.debug("dot detected!",t,u,e,p);break}this.debug("globstar swallow a segment, and continue"),u++}return!(!n||(this.debug("\n>>> no match, partial?",t,u,e,p),u!==o))}if("string"==typeof c?(h=l===c,this.debug("string match",c,l,h)):(h=l.match(c),this.debug("pattern match",c,l,h)),!h)return!1}if(s===o&&i===a)return!0;if(s===o)return n;if(i===a)return s===o-1&&""===t[s];throw new Error("wtf?")}braceExpand(){return G(this.pattern,this.options)}parse(t,e){U(t);const n=this.options;if("**"===t){if(!n.noglobstar)return q;t="*"}if(""===t)return"";let r="",s=!!n.nocase,i=!1;const o=[],a=[];let h,c,l,u,p=!1,f=-1,d=-1;const g="."===t.charAt(0)?"":n.dot?"(?!(?:^|\\/)\\.{1,2}(?:$|\\/))":"(?!\\.)",m=()=>{if(h){switch(h){case"*":r+="[^/]*?",s=!0;break;case"?":r+="[^/]",s=!0;break;default:r+="\\"+h}this.debug("clearStateChar %j %j",h,r),h=!1}};for(let e,g=0;g<t.length&&(e=t.charAt(g));g++)if(this.debug("%s\t%s %s %j",t,g,r,e),i){if("/"===e)return!1;D[e]&&(r+="\\"),r+=e,i=!1}else switch(e){case"/":return!1;case"\\":m(),i=!0;continue;case"?":case"*":case"+":case"@":case"!":if(this.debug("%s\t%s %s %j <-- stateChar",t,g,r,e),p){this.debug("  in class"),"!"===e&&g===d+1&&(e="^"),r+=e;continue}this.debug("call clearStateChar %j",h),m(),h=e,n.noext&&m();continue;case"(":if(p){r+="(";continue}if(!h){r+="\\(";continue}o.push({type:h,start:g-1,reStart:r.length,open:L[h].open,close:L[h].close}),r+="!"===h?"(?:(?!(?:":"(?:",this.debug("plType %j %j",h,r),h=!1;continue;case")":if(p||!o.length){r+="\\)";continue}m(),s=!0,l=o.pop(),r+=l.close,"!"===l.type&&a.push(l),l.reEnd=r.length;continue;case"|":if(p||!o.length){r+="\\|";continue}m(),r+="|";continue;case"[":if(m(),p){r+="\\"+e;continue}p=!0,d=g,f=r.length,r+=e;continue;case"]":if(g===d+1||!p){r+="\\"+e;continue}c=t.substring(d+1,g);try{RegExp("["+c+"]")}catch(t){u=this.parse(c,Z),r=r.substr(0,f)+"\\["+u[0]+"\\]",s=s||u[1],p=!1;continue}s=!0,p=!1,r+=e;continue;default:m(),!D[e]||"^"===e&&p||(r+="\\"),r+=e}for(p&&(c=t.substr(d+1),u=this.parse(c,Z),r=r.substr(0,f)+"\\["+u[0],s=s||u[1]),l=o.pop();l;l=o.pop()){let t;t=r.slice(l.reStart+l.open.length),this.debug("setting tail",r,l),t=t.replace(/((?:\\{2}){0,64})(\\?)\|/g,((t,e,n)=>(n||(n="\\"),e+e+n+"|"))),this.debug("tail=%j\n   %s",t,t,l,r);const e="*"===l.type?"[^/]*?":"?"===l.type?"[^/]":"\\"+l.type;s=!0,r=r.slice(0,l.reStart)+e+"\\("+t}m(),i&&(r+="\\\\");const b=H[r.charAt(0)];for(let t=a.length-1;t>-1;t--){const n=a[t],s=r.slice(0,n.reStart),i=r.slice(n.reStart,n.reEnd-8);let o=r.slice(n.reEnd);const h=r.slice(n.reEnd-8,n.reEnd)+o,c=s.split("(").length-1;let l=o;for(let t=0;t<c;t++)l=l.replace(/\)[+*?]?/,"");o=l;r=s+i+o+(""===o&&e!==Z?"$":"")+h}if(""!==r&&s&&(r="(?=.)"+r),b&&(r=g+r),e===Z)return[r,s];if(!s)return t.replace(/\\(.)/g,"$1");const v=n.nocase?"i":"";try{return Object.assign(new RegExp("^"+r+"$",v),{_glob:t,_src:r})}catch(t){return new RegExp("$.")}}makeRe(){if(this.regexp||!1===this.regexp)return this.regexp;const t=this.set;if(!t.length)return this.regexp=!1,this.regexp;const e=this.options,n=e.noglobstar?"[^/]*?":e.dot?"(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?":"(?:(?!(?:\\/|^)\\.).)*?",r=e.nocase?"i":"";let s=t.map((t=>(t=t.map((t=>"string"==typeof t?t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"):t===q?q:t._src)).reduce(((t,e)=>(t[t.length-1]===q&&e===q||t.push(e),t)),[]),t.forEach(((e,r)=>{e===q&&t[r-1]!==q&&(0===r?t.length>1?t[r+1]="(?:\\/|"+n+"\\/)?"+t[r+1]:t[r]=n:r===t.length-1?t[r-1]+="(?:\\/|"+n+")?":(t[r-1]+="(?:\\/|\\/"+n+"\\/)"+t[r+1],t[r+1]=q))})),t.filter((t=>t!==q)).join("/")))).join("|");s="^(?:"+s+")$",this.negate&&(s="^(?!"+s+").*$");try{this.regexp=new RegExp(s,r)}catch(t){this.regexp=!1}return this.regexp}match(t,e=this.partial){if(this.debug("match",t,this.pattern),this.comment)return!1;if(this.empty)return""===t;if("/"===t&&e)return!0;const n=this.options;"/"!==T.sep&&(t=t.split(T.sep).join("/")),t=t.split(I),this.debug(this.pattern,"split",t);const r=this.set;let s;this.debug(this.pattern,"set",r);for(let e=t.length-1;e>=0&&(s=t[e],!s);e--);for(let i=0;i<r.length;i++){const o=r[i];let a=t;n.matchBase&&1===o.length&&(a=[s]);if(this.matchOne(a,o,e))return!!n.flipNegate||!this.negate}return!n.flipNegate&&this.negate}static defaults(t){return F.defaults(t).Minimatch}}F.Minimatch=J;class K{}class Q extends K{}class V{}class W{constructor(){this.added=[],this.changed=[]}}class X{constructor(){this.status="init",this.message=""}}var Y;!function(t){t[t.HaveNothingUpdate=0]="HaveNothingUpdate",t[t.Success=1]="Success",t[t.Failed=2]="Failed"}(Y||(Y={}));class tt{constructor(t,e){this.queue=[],this.activeCount=0,this.concurrency=t,this.onFinnish=e}addTask(t){return p(this,void 0,void 0,(function*(){this.queue.push(t),this.run()}))}stop(){this.queue=[]}run(){return p(this,void 0,void 0,(function*(){if(0===this.activeCount&&0===this.queue.length&&this.onFinnish&&this.onFinnish(),this.activeCount<this.concurrency&&this.queue.length>0){const t=this.queue.shift();this.activeCount++,t.task().then((e=>{t.taskReslove&&t.taskReslove(e)})).catch((e=>{t.taskReject&&t.taskReject(e)})).finally((()=>{this.activeCount--,this.run()}))}}))}}function et(e){return t("sha256").update(e).digest("hex")}function nt(t,e){if("function"==typeof t)return t(e);if(t&&Array.isArray(t)&&0!==t.length){return new RegExp(t.reduce(((t,e)=>t+"|"+N.makeRe(e).source),"").substring(1)).test(e)}return!1}function rt(t,o={}){var a,h;const c=r(t),l=e(t);if(c.isFile()){if(nt(null===(a=null==o?void 0:o.files)||void 0===a?void 0:a.exclude,l))return null;const e=new K;return e.name=l,e.hash=et(s(t)),e}if(c.isDirectory()){if(nt(null===(h=null==o?void 0:o.folders)||void 0===h?void 0:h.exclude,l))return null;const e=new Q;return e.name=l,e.children=i(t).map((e=>rt(n(t,e),o))).filter((t=>null!==t)),e.hash=et(e.children.map((t=>t.hash)).join("")),e}return null}function st(r,s={},h=1){return new Promise(((c,l)=>{o(r,((o,u)=>{var p,f;if(o)l(o);else{const o=e(r);if(u.isFile()){if(nt(null===(p=null==s?void 0:s.files)||void 0===p?void 0:p.exclude,o))return c(null);const e=new K;e.name=o;const n=a(r),i=t("sha256");n.pipe(i),n.on("end",(()=>{e.hash=i.digest("hex"),c(e),n.close()})),n.on("error",(t=>{l(t)}))}else{if(!u.isDirectory())return c(null);{if(nt(null===(f=null==s?void 0:s.folders)||void 0===f?void 0:f.exclude,o))return c(null);const t=new Q;t.name=o;const e=i(r),a=[],u=new tt(h,(()=>{t.children=a.filter((t=>null!==t)),t.hash=et(t.children.map((t=>t.hash)).join("")),c(t)}));for(const t of e)u.addTask({task:()=>st(n(r,t),s),taskReslove:t=>{a.push(t)},taskReject:t=>{u.stop(),l(t)}})}}}}))}))}function it(t){t&&t.children&&(t.childrenObject=t.children.reduce(((t,e)=>(e.children&&it(e),t[e.name]=e,t)),{}))}function ot(t,e,n=new W,r="."){return e.hash===t.hash||(e.children?e.children.forEach((e=>{e=e,t.childrenObject&&t.childrenObject[e.name]?ot(t.childrenObject[e.name],e,n,r+"/"+e.name):at(e,r+"/"+e.name,n.added)})):n.changed.push({filePath:r,hash:e.hash})),n}function at(t,e,n){t.children?t.children.forEach((t=>{at(t,e+"/"+t.name,n)})):n.push({filePath:e,hash:t.hash})}function ht(t,e){return new Promise(((n,r)=>{const s=l(),i=h(e),o=a(t);o.on("close",n),o.on("error",r),i.on("error",r),o.pipe(s).pipe(i)}))}function ct(t,e,r,s=!1){return p(this,void 0,void 0,(function*(){if(t.children)for(let n=0;n<t.children.length;n++)yield ct(t.children[n],e+(s?"":"/"+t.name),r);else yield ht(e+"/"+t.name,n(r,t.hash+".gz"))}))}function lt(t,e){return new Promise((n=>{o(t,((r,s)=>{var i;n(!r&&(s.isFile()&&(null===(i=rt(t))||void 0===i?void 0:i.hash)===e))}))}))}function ut(e,n,r,i){return new Promise(((o,a)=>{if(c(r)&&et(s(r))===e)o(!0);else{const s=t("sha256"),c=u(),l=h(r);i(n).then((t=>{t.pipe(c),t.once("error",(t=>{c.close(),l.close(),s.destroy(),a(t)})),c.pipe(s),c.pipe(l),t.once("end",(()=>{s.digest("hex")!==e?(s.destroy(),a(new Error("下载文件出错"))):o(!0)}))}),(t=>{a(t)}))}}))}export{W as DiffVersionHashResult,V as DiffVersionHashResultItem,K as HashedFile,Q as HashedFolder,X as UpdateInfo,Y as UpdateStatus,lt as checkFileExitAndHash,ot as diffVersionHash,ut as downAndungzip,ht as gzip,it as handleHashedFolderChildrenToObject,et as hash256,rt as hashElement,st as hashElementPromiseQueue,at as pushdiffVersionHashResult,nt as reduceGlobPatterns,ct as zipHashElement};
